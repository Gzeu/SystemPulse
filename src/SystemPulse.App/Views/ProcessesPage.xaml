<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="SystemPulse.App.Views.ProcessesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="using:SystemPulse.App.Converters"
    xmlns:controls="using:CommunityToolkit.WinUI.Controls"
    Background="{ThemeResource SolidBackgroundFillColorBase}">

    <Page.Resources>
        <converters:BytesToReadableConverter x:Key="BytesConverter"/>
        <converters:PercentageConverter x:Key="PercentageConverter"/>
        <converters:ProcessStateColorConverter x:Key="StateColorConverter"/>
    </Page.Resources>

    <Grid Padding="24" RowSpacing="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header Section -->
        <Grid Grid.Row="0" ColumnSpacing="12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0" Spacing="8">
                <TextBlock 
                    Text="Process Management" 
                    Style="{ThemeResource TitleTextBlockStyle}" 
                    FontWeight="SemiBold"/>
                <TextBlock 
                    Text="Monitor and manage running processes" 
                    FontSize="14" 
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                <Button 
                    Content="Refresh" 
                    Command="{x:Bind ViewModel.LoadProcessesCommand}"
                    IsEnabled="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolNegationConverter}}">
                    <Button.KeyboardAccelerators>
                        <KeyboardAccelerator Key="F5"/>
                    </Button.KeyboardAccelerators>
                </Button>
            </StackPanel>
        </Grid>

        <!-- Search and Filter Bar -->
        <Grid Grid.Row="1" ColumnSpacing="12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <!-- Search Box -->
            <TextBox 
                Grid.Column="0"
                PlaceholderText="Search processes by name or PID..."
                Text="{x:Bind ViewModel.SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                VerticalAlignment="Center">
                <TextBox.Resources>
                    <SolidColorBrush x:Key="TextControlBackground" Color="Transparent"/>
                </TextBox.Resources>
            </TextBox>

            <!-- Action Buttons -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                <Button 
                    Content="Kill Process" 
                    Command="{x:Bind ViewModel.KillProcessCommand}"
                    IsEnabled="{x:Bind ViewModel.SelectedProcess, Mode=OneWay, Converter={StaticResource NullToBoolConverter}}"
                    Style="{ThemeResource AccentButtonStyle}"/>
                
                <Button 
                    Content="Suspend" 
                    Command="{x:Bind ViewModel.SuspendProcessCommand}"
                    IsEnabled="{x:Bind ViewModel.SelectedProcess, Mode=OneWay, Converter={StaticResource NullToBoolConverter}}"/>
                
                <Button 
                    Content="Resume" 
                    Command="{x:Bind ViewModel.ResumeProcessCommand}"
                    IsEnabled="{x:Bind ViewModel.SelectedProcess, Mode=OneWay, Converter={StaticResource NullToBoolConverter}}"/>
            </StackPanel>
        </Grid>

        <!-- Process DataGrid -->
        <Border 
            Grid.Row="2"
            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="1"
            CornerRadius="8">
            
            <Grid>
                <!-- Loading Overlay -->
                <ProgressRing 
                    IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                    Width="60" 
                    Height="60"
                    HorizontalAlignment="Center" 
                    VerticalAlignment="Center"
                    Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>

                <!-- DataGrid -->
                <ScrollViewer 
                    HorizontalScrollBarVisibility="Auto" 
                    VerticalScrollBarVisibility="Auto"
                    Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}, ConverterParameter=Inverse}">
                    
                    <controls:DataGrid
                        x:Name="ProcessGrid"
                        ItemsSource="{x:Bind ViewModel.Processes, Mode=OneWay}"
                        SelectedItem="{x:Bind ViewModel.SelectedProcess, Mode=TwoWay}"
                        AutoGenerateColumns="False"
                        CanUserSortColumns="True"
                        CanUserReorderColumns="True"
                        IsReadOnly="True"
                        GridLinesVisibility="Horizontal"
                        HeadersVisibility="Column"
                        AlternatingRowBackground="Transparent"
                        ColumnHeaderHeight="44"
                        RowHeight="36"
                        SelectionMode="Single">

                        <!-- Context Menu -->
                        <controls:DataGrid.ContextFlyout>
                            <MenuFlyout>
                                <MenuFlyoutItem 
                                    Text="Kill Process" 
                                    Command="{x:Bind ViewModel.KillProcessCommand}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE711;"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                
                                <MenuFlyoutItem 
                                    Text="Suspend" 
                                    Command="{x:Bind ViewModel.SuspendProcessCommand}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE769;"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                
                                <MenuFlyoutItem 
                                    Text="Resume" 
                                    Command="{x:Bind ViewModel.ResumeProcessCommand}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE768;"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>

                                <MenuFlyoutSeparator/>

                                <MenuFlyoutSubItem Text="Set Priority">
                                    <MenuFlyoutItem Text="Realtime" Tag="Realtime" Click="Priority_Click"/>
                                    <MenuFlyoutItem Text="High" Tag="High" Click="Priority_Click"/>
                                    <MenuFlyoutItem Text="Above Normal" Tag="AboveNormal" Click="Priority_Click"/>
                                    <MenuFlyoutItem Text="Normal" Tag="Normal" Click="Priority_Click"/>
                                    <MenuFlyoutItem Text="Below Normal" Tag="BelowNormal" Click="Priority_Click"/>
                                    <MenuFlyoutItem Text="Low" Tag="Low" Click="Priority_Click"/>
                                </MenuFlyoutSubItem>

                                <MenuFlyoutSeparator/>

                                <MenuFlyoutItem 
                                    Text="Properties" 
                                    Command="{x:Bind ViewModel.ShowProcessDetailsCommand}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE946;"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                
                                <MenuFlyoutItem 
                                    Text="Open File Location" 
                                    Command="{x:Bind ViewModel.OpenFileLocationCommand}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE8B7;"/>
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                            </MenuFlyout>
                        </controls:DataGrid.ContextFlyout>

                        <!-- Columns -->
                        <controls:DataGrid.Columns>
                            <!-- Process Name -->
                            <controls:DataGridTextColumn 
                                Header="Process Name" 
                                Binding="{Binding Name}" 
                                Width="250"
                                CanUserSort="True"/>

                            <!-- PID -->
                            <controls:DataGridTextColumn 
                                Header="PID" 
                                Binding="{Binding PID}" 
                                Width="80"
                                CanUserSort="True"/>

                            <!-- CPU Usage -->
                            <controls:DataGridTextColumn 
                                Header="CPU %" 
                                Binding="{Binding CPUUsage, Converter={StaticResource PercentageConverter}}" 
                                Width="100"
                                CanUserSort="True"/>

                            <!-- Memory Usage -->
                            <controls:DataGridTextColumn 
                                Header="Memory" 
                                Binding="{Binding MemoryUsage, Converter={StaticResource BytesConverter}}" 
                                Width="120"
                                CanUserSort="True"/>

                            <!-- Threads -->
                            <controls:DataGridTextColumn 
                                Header="Threads" 
                                Binding="{Binding ThreadCount}" 
                                Width="80"
                                CanUserSort="True"/>

                            <!-- User -->
                            <controls:DataGridTextColumn 
                                Header="User" 
                                Binding="{Binding Username}" 
                                Width="150"
                                CanUserSort="True"/>

                            <!-- Status -->
                            <controls:DataGridTemplateColumn 
                                Header="Status" 
                                Width="120"
                                CanUserSort="True">
                                <controls:DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                                            <Ellipse 
                                                Width="8" 
                                                Height="8" 
                                                Fill="{Binding Status, Converter={StaticResource StateColorConverter}}"/>
                                            <TextBlock 
                                                Text="{Binding Status}" 
                                                FontSize="13"/>
                                        </StackPanel>
                                    </DataTemplate>
                                </controls:DataGridTemplateColumn.CellTemplate>
                            </controls:DataGridTemplateColumn>

                            <!-- Priority -->
                            <controls:DataGridTextColumn 
                                Header="Priority" 
                                Binding="{Binding Priority}" 
                                Width="120"
                                CanUserSort="True"/>

                            <!-- Path -->
                            <controls:DataGridTextColumn 
                                Header="Path" 
                                Binding="{Binding Path}" 
                                Width="*"
                                CanUserSort="True"/>
                        </controls:DataGrid.Columns>
                    </controls:DataGrid>
                </ScrollViewer>
            </Grid>
        </Border>

        <!-- Status Bar -->
        <Border 
            Grid.Row="3"
            Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
            BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
            BorderThickness="1"
            CornerRadius="8"
            Padding="16,12">
            
            <Grid ColumnSpacing="20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Process Count -->
                <TextBlock Grid.Column="0" FontSize="13">
                    <Run Text="Total Processes: "/>
                    <Run Text="{x:Bind ViewModel.TotalProcessCount, Mode=OneWay}" FontWeight="SemiBold"/>
                    <Run Text=" | Filtered: "/>
                    <Run Text="{x:Bind ViewModel.FilteredProcessCount, Mode=OneWay}" FontWeight="SemiBold"/>
                </TextBlock>

                <!-- Status Text -->
                <TextBlock 
                    Grid.Column="1" 
                    Text="{x:Bind ViewModel.StatusText, Mode=OneWay}" 
                    FontSize="13" 
                    Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                    HorizontalAlignment="Center"/>

                <!-- Selected Process Info -->
                <TextBlock Grid.Column="2" FontSize="13" Visibility="{x:Bind ViewModel.SelectedProcess, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                    <Run Text="Selected: "/>
                    <Run Text="{x:Bind ViewModel.SelectedProcess.Name, Mode=OneWay}" FontWeight="SemiBold"/>
                    <Run Text=" (PID: "/>
                    <Run Text="{x:Bind ViewModel.SelectedProcess.PID, Mode=OneWay}"/>
                    <Run Text=")"/>
                </TextBlock>
            </Grid>
        </Border>
    </Grid>
</Page>
